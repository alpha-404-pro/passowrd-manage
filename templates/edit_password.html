{% extends 'base.html' %}

{% block title %}Edit Password - Password Manager{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8 col-lg-6">
        <div class="card shadow">
            <div class="card-header">
                <h2 class="mb-0">
                    <i class="fas fa-edit"></i> Edit Password
                </h2>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    <div class="mb-3">
                        <label class="form-label">Website Name *</label>
                        {{ form.website_name }}
                        {% if form.website_name.errors %}
                            <div class="text-danger">{{ form.website_name.errors }}</div>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Username/Email <small class="text-muted">(Optional)</small></label>
                        {{ form.username }}
                        {% if form.username.errors %}
                            <div class="text-danger">{{ form.username.errors }}</div>
                        {% endif %}
                        <small class="form-text text-muted">Leave blank if not applicable</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password *</label>
                        <div class="input-group password-container">
                            <!-- Hidden actual password field for form submission -->
                            <input type="password" name="password" id="id_password" class="form-control password-field password-input-hidden" value="{{ form.password.value|default:'' }}" required>
                            
                            <!-- Visible password display/input -->
                            <div class="password-display" id="passwordDisplay" onclick="focusPasswordInput()">
                                <span id="passwordText"></span>
                                <span class="cursor-blink" id="passwordCursor">|</span>
                            </div>
                            
                            <button type="button" class="btn btn-outline-secondary" onclick="togglePasswordVisibility()">
                                <i class="fas fa-eye" id="togglePasswordIcon"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="generateRandomPassword()">
                                <i class="fas fa-random"></i> Generate
                            </button>
                        </div>
                        
                        <!-- Invisible input for typing -->
                        <input type="text" id="passwordInput" class="form-control" style="position: absolute; left: -9999px;" autocomplete="off">
                        
                        {% if form.password.errors %}
                            <div class="text-danger">{{ form.password.errors }}</div>
                        {% endif %}
                        <div class="mt-2">
                            <label for="passwordLength" class="form-label">Password Length: <span id="lengthValue">12</span></label>
                            <input type="range" class="form-range" id="passwordLength" min="8" max="50" value="12" onchange="updateLengthValue()">
                        </div>
                    </div>
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancel</a>
                        <button type="submit" class="btn btn-primary">Update Password</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let isPasswordVisible = false;
let passwordValue = '{{ form.password.value|default:"" }}';

function updateLengthValue() {
    const slider = document.getElementById('passwordLength');
    document.getElementById('lengthValue').textContent = slider.value;
}

function colorizePassword(password) {
    if (!password) return '';
    
    return password.split('').map(char => {
        if (/[0-9]/.test(char)) {
            return `<span class="char-numeric">${char}</span>`;
        } else if (/[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?~`]/.test(char)) {
            return `<span class="char-special">${char}</span>`;
        } else {
            return `<span class="char-normal">${char}</span>`;
        }
    }).join('');
}

function updatePasswordDisplay() {
    const passwordText = document.getElementById('passwordText');
    const passwordCursor = document.getElementById('passwordCursor');
    const hiddenInput = document.getElementById('id_password');
    
    // Update hidden input for form submission
    hiddenInput.value = passwordValue;
    
    if (isPasswordVisible) {
        passwordText.innerHTML = colorizePassword(passwordValue);
        passwordCursor.style.display = 'inline';
    } else {
        passwordText.innerHTML = 'â€¢'.repeat(passwordValue.length);
        passwordCursor.style.display = 'inline';
    }
}

function togglePasswordVisibility() {
    const icon = document.getElementById('togglePasswordIcon');
    
    isPasswordVisible = !isPasswordVisible;
    
    if (isPasswordVisible) {
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
    
    updatePasswordDisplay();
}

function focusPasswordInput() {
    const invisibleInput = document.getElementById('passwordInput');
    invisibleInput.focus();
    invisibleInput.value = passwordValue;
    invisibleInput.setSelectionRange(passwordValue.length, passwordValue.length);
}

function generateRandomPassword() {
    const length = document.getElementById('passwordLength').value;
    
    fetch('/generate-password/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({length: length})
    })
    .then(response => response.json())
    .then(data => {
        passwordValue = data.password;
        
        // Show the generated password for 3 seconds
        if (!isPasswordVisible) {
            togglePasswordVisibility();
            setTimeout(() => {
                if (isPasswordVisible) {
                    togglePasswordVisibility();
                }
            }, 3000);
        }
        
        updatePasswordDisplay();
    });
}

// Handle typing in the invisible input
document.getElementById('passwordInput').addEventListener('input', function(e) {
    passwordValue = e.target.value;
    updatePasswordDisplay();
});

// Handle special keys
document.getElementById('passwordInput').addEventListener('keydown', function(e) {
    if (e.key === 'Backspace' && passwordValue.length > 0) {
        passwordValue = passwordValue.slice(0, -1);
        updatePasswordDisplay();
        e.preventDefault();
    }
});

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    // Initialize password display with existing value
    updatePasswordDisplay();
    
    // Add blinking cursor animation
    setInterval(() => {
        const cursor = document.getElementById('passwordCursor');
        if (cursor) {
            cursor.style.opacity = cursor.style.opacity === '0' ? '1' : '0';
        }
    }, 500);
});

// Focus management
document.getElementById('passwordDisplay').addEventListener('click', focusPasswordInput);
</script>
{% endblock %}
