{% extends 'base.html' %}

{% block title %}Add Password – Password Manager{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-8 col-lg-6">
    <div class="card shadow">
      <div class="card-header">
        <h2 class="mb-0"><i class="fas fa-plus"></i> Add New Password</h2>
      </div>

      <div class="card-body">
        <form method="post" novalidate>
          {% csrf_token %}

          <!-- WEBSITE NAME -------------------------------------------------->
          <div class="mb-3">
            <label class="form-label">Website Name *</label>
            {{ form.website_name }}
            {% if form.website_name.errors %}
              <div class="text-danger">{{ form.website_name.errors }}</div>
            {% endif %}
          </div>

          <!-- USERNAME (OPTIONAL) ------------------------------------------>
          <div class="mb-3">
            <label class="form-label">Username / Email
              <small class="text-muted">(Optional)</small>
            </label>
            {{ form.username }}
            {% if form.username.errors %}
              <div class="text-danger">{{ form.username.errors }}</div>
            {% endif %}
            <small class="form-text text-muted">Leave blank if not applicable</small>
          </div>

          <!-- PASSWORD FIELD ------------------------------------------------>
          <div class="mb-3">
            <label class="form-label">Password *</label>

            <!-- Hidden field actually submitted -->
            <input type="hidden" name="password" id="id_password" required>

            <!-- Visual editor -->
            <div id="passwordEditor"
                 class="password-display"
                 contenteditable="true"
                 spellcheck="false"
                 oninput="syncEditorToHidden()"
                 onpaste="handlePaste(event)"
                 onclick="placeCaretAtEnd(this)">
            </div>

            <div class="btn-group mt-2" role="group">
              <button type="button"
                      class="btn btn-outline-secondary"
                      id="toggleBtn"
                      onclick="toggleVisibility()">
                <i class="fas fa-eye" id="toggleIcon"></i>
              </button>

              <button type="button"
                      class="btn btn-outline-secondary"
                      onclick="generatePassword()">
                <i class="fas fa-random"></i> Generate
              </button>
            </div>

            <div class="mt-3">
              <label for="pwdLength" class="form-label">
                Password Length: <span id="lenVal">12</span>
              </label>
              <input type="range"
                     class="form-range"
                     id="pwdLength"
                     min="8" max="50" value="12"
                     oninput="document.getElementById('lenVal').innerText=this.value">
            </div>
          </div>

          <!-- SUBMIT -------------------------------------------------------->
          <div class="d-grid gap-2 d-md-flex justify-content-md-end">
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">Cancel</a>
            <button type="submit" class="btn btn-primary">Save Password</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
/* -------------------------------------------------------------------------
   GLOBAL STATE
---------------------------------------------------------------------------*/
let visible = false;

/* -------------------------------------------------------------------------
   HELPERS
---------------------------------------------------------------------------*/
function colourise(text) {
  return text.replace(/./g, c => {
    if (/\d/.test(c))         return `<span class="char-numeric">${c}</span>`;
    if (/[!@#$%^&*()[\]{}<>\/?~`_\-+=|:;"',.]/.test(c))
                              return `<span class="char-special">${c}</span>`;
    return `<span class="char-normal">${c}</span>`;
  });
}

function syncEditorToHidden() {
  const editor  = document.getElementById('passwordEditor');
  const hidden  = document.getElementById('id_password');
  hidden.value  = editor.innerText.trim();

  if (visible) {
    editor.innerHTML = colourise(hidden.value);
    placeCaretAtEnd(editor);
  }
}

function toggleVisibility() {
  const icon   = document.getElementById('toggleIcon');
  const editor = document.getElementById('passwordEditor');
  visible = !visible;

  if (visible) {           // SHOW
    icon.classList.replace('fa-eye', 'fa-eye-slash');
    editor.innerHTML = colourise(document.getElementById('id_password').value);
  } else {                 // HIDE
    icon.classList.replace('fa-eye-slash', 'fa-eye');
    editor.textContent = '•'.repeat(document.getElementById('id_password').value.length);
  }
  placeCaretAtEnd(editor);
}

function generatePassword() {
  const len = document.getElementById('pwdLength').value;

  fetch('/generate-password/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
    },
    body: JSON.stringify({length: len})
  })
  .then(r => r.json())
  .then(({password}) => {
    document.getElementById('id_password').value = password;
    document.getElementById('passwordEditor').innerHTML = colourise(password);
    visible = true;
    document.getElementById('toggleIcon').classList.replace('fa-eye', 'fa-eye-slash');
    setTimeout(toggleVisibility, 3000);          // auto-hide after 3 s
  });
}

function handlePaste(e) {
  e.preventDefault();
  const text = (e.clipboardData || window.clipboardData).getData('text');
  document.execCommand('insertText', false, text);
}

function placeCaretAtEnd(el) {
  const range = document.createRange();
  const sel   = window.getSelection();
  range.selectNodeContents(el);
  range.collapse(false);
  sel.removeAllRanges();
  sel.addRange(range);
}

/* -------------------------------------------------------------------------
   INITIALISE
---------------------------------------------------------------------------*/
document.addEventListener('DOMContentLoaded', () => {
  // Start in hidden mode
  toggleVisibility();   // sets bullets without revealing password
  toggleVisibility();   // immediately hide again to sync state
});
</script>
{% endblock %}
